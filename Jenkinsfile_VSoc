node {
    def app
    environment {
        JAVA_TOOL_OPTIONS = "-Duser.home=/var/maven"
        JAVA_TOOL_OPTIONS = "-Duser.home=/home/jenkins"
        // holds reference to docker image
        MY_DOCKER_REPO = "ctraore"
        IMAGE = readMavenPom().getArtifactId()
        IMAGE_VERSION = readMavenPom().getVersion()
        IMAGE_TAG = "${env.BUILD_NUMBER}"
    }

    stage('Clone repository') {
        checkout scm
    }

    stage('Mvn Package') {
        def mvnHome = tool name: 'maven3', type: 'maven'
        def mvnCMD = "${mvnHome}/bin/mvn"
        sh "${mvnCMD} clean package"
    }

    stage('Build Docker Image') {
        sh "docker build -t ctraore/${IMAGE}-${IMAGE_VERSION}:${IMAGE_TAG} ."
    }

    stage('Push Docker Image') {
       withCredentials([string(credentialsId: 'DOCKERHUB-CREDS', variable: 'dockerHubPwd')]) {
            sh "docker login -u ${MY_DOCKER_REPO} -p ${dockerHubPwd}"
        }
        sh "docker push ctraore/${IMAGE}-${IMAGE_VERSION}:${IMAGE_TAG}"
    }
}
