node {
    def app
    def MY_DOCKER_REPO = "ctraore"
    def IMAGE = readMavenPom().getArtifactId()
    def IMAGE_VERSION = readMavenPom().getVersion()
    def IMAGE_TAG = "${env.BUILD_NUMBER}"

    environment {
        JAVA_TOOL_OPTIONS = "-Duser.home=/var/maven"
        JAVA_TOOL_OPTIONS = "-Duser.home=/home/jenkins"
    }

    stage('Clone repository') {
        checkout scm
    }

    stage('Mvn Package') {
        def mvnHome = tool name: 'maven3', type: 'maven'
        def mvnCMD = "${mvnHome}/bin/mvn"
        sh "${mvnCMD} clean package"
    }

    stage('Build Docker Image') {
        sh "docker build -t ${MY_DOCKER_REPO}/${IMAGE}-${IMAGE_VERSION}:${IMAGE_TAG} ."
    }

    stage('Push Docker Image') {
       withCredentials([string(credentialsId: 'DOCKERHUB-CREDS', variable: 'dockerHubPwd')]) {
            sh "docker login -u ${MY_DOCKER_REPO} -p ${dockerHubPwd}"
        }
        sh "docker push ${MY_DOCKER_REPO}/${IMAGE}-${IMAGE_VERSION}:${IMAGE_TAG}"
    }
}
